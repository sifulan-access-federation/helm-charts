apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "cas.fullname" . }}
  labels:
    app: {{ template "cas.name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
data:
{{- define "cas.jetty.preprint-services" }}
africarxiv:
  id: '203948234207264'
  name: 'AfricArXiv Preprints'
agrixiv:
  id: '203948234207244'
  name: AgriXiv Preprints
  domain: agrixiv.org
arabixiv:
  id: '203948234207262'
  name: Arabixiv Preprints
  domain: arabixiv.org
banglarxiv:
  id: '203948234207266'
  name: Banglarxiv Preprints
bitss:
  id: '203948234207245'
  name: BITSS Preprints
bodoarxiv:
  id: '203948234207268'
  name: BodoArXiv Preprints
eartharxiv:
  id: '203948234207261'
  name: EarthArXiv Preprints
  domain: eartharxiv.org
ecoevorxiv:
  id: '203948234207265'
  name: EcoEvoRxiv Preprints
  domain: ecoevorxiv.org
ecsarxiv:
  id: '203948234207259'
  name: ECSarXiv Preprints
  domain: ecsarxiv.org
edarxiv:
  id: '203948234207270'
  name: EdArXiv Preprints
  domain: edarxiv.org
engrxiv:
  id: '203948234207242'
  name: engrXiv Preprints
  domain: engrxiv.org
experimentalprotocols:
  id: '203948234207258'
  name: Experimental Protocols Preprints
focusarchive:
  id: '203948234207248'
  name: FocUS Archive Preprints
frenxiv:
  id: '203948234207263'
  name: Frenxiv Preprints
  domain: frenxiv.org
inarxiv:
  id: '203948234207257'
  name: INA-Rxiv Preprints
indiarxiv:
  id: '203948234207271'
  name: IndiaRxiv Preprints
  domain: indiarxiv.org
lawarxiv:
  id: '203948234207247'
  name: LawArXiv Papers
lissa:
  id: '203948234207249'
  name: LIS Scholarship Archive Preprints
livedata:
  id: '203948234207254'
  name: LiveData
marxiv:
  id: '203948234207260'
  name: MarXiv Papers
  domain: marxiv.org
medarxiv:
  id: '203948234207256'
  name: MedArXiv Preprints
mediarxiv:
  id: '203948234207267'
  name: MediArXiv Preprints
  domain: mediarxiv.org
metaarxiv:
  id: '203948234207269'
  name: MetaArXiv Preprints
mindrxiv:
  id: '203948234207250'
  name: MindRxiv Preprints
  domain: mindrxiv.org
nutrixiv:
  id: '203948234207255'
  name: NutriXiv Preprints
paleorxiv:
  id: '203948234207251'
  name: PaleorXiv Preprints
  domain: paleorxiv.org
psyarxiv:
  id: '203948234207243'
  name: PsyArXiv Preprints
  domain: psyarxiv.com
scielo:
  id: '203948234207246'
  name: SciELO Preprints
socarxiv:
  id: '203948234207241'
  name: SocArXiv Preprints
sportrxiv:
  id: '203948234207252'
  name: SportRxiv Preprints
  domain: sportrxiv.org
thesiscommons:
  id: '203948234207253'
  name: Thesis Commons
  domain: thesiscommons.org
{{- end -}}
{{- define "cas.apache.inlineconfigs" }}
shibboleth/shibboleth2.xml: |-
  <SPConfig xmlns="urn:mace:shibboleth:2.0:native:sp:config"
      xmlns:conf="urn:mace:shibboleth:2.0:native:sp:config"
      xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion"
      xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol"
      xmlns:md="urn:oasis:names:tc:SAML:2.0:metadata"
      clockSkew="180">

      <InProcess logger="native.logger" checkSpoofing="true"/>

      <!--
      By default, in-memory StorageService, ReplayCache, ArtifactMap, and SessionCache
      are used. See example-shibboleth2.xml for samples of explicitly configuring them.
      -->

      <!--
      To customize behavior for specific resources on Apache, and to link vhosts or
      resources to ApplicationOverride settings below, use web server options/commands.
      See https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfigurationElements for help.

      For examples with the RequestMap XML syntax instead, see the example-shibboleth2.xml
      file, and the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPRequestMapHowTo topic.
      -->

      <!-- The ApplicationDefaults element is where most of Shibboleth's SAML bits are defined. -->
      <ApplicationDefaults entityID="https://{{ .Values.casDomain }}/shibboleth-sp"
                            REMOTE_USER="eppn persistent-id targeted-id" attributePrefix="AUTH-">

          <!--
          Controls session lifetimes, address checks, cookie handling, and the protocol handlers.
          You MUST supply an effectively unique handlerURL value for each of your applications.
          The value defaults to /Shibboleth.sso, and should be a relative path, with the SP computing
          a relative value based on the virtual host. Using handlerSSL="true", the default, will force
          the protocol to be https. You should also set cookieProps to "https" for SSL-only sites.
          Note that while we default checkAddress to "false", this has a negative impact on the
          security of your site. Stealing sessions via cookie theft is much easier with this disabled.
          -->
          <Sessions lifetime="28800" timeout="3600" relayState="ss:mem"
                    checkAddress="false" handlerSSL="false" cookieProps="http">

              <!--
              Configures SSO for a default IdP. To allow for >1 IdP, remove
              entityID property and adjust discoveryURL to point to discovery service.
              (Set discoveryProtocol to "WAYF" for legacy Shibboleth WAYF support.)
              You can also override entityID on /Login query string, or in RequestMap/htaccess.
              -->
              <!-- <SSO entityID="https://idp.testshib.org/idp/shibboleth"
                    discoveryProtocol="SAMLDS" discoveryURL="https://ds.example.org/DS/WAYF">
                SAML2 SAML1
              </SSO> -->
              <!-- <SSO entityID="https://idp.testshib.org/idp/shibboleth">SAML2 SAML1</SSO> -->
              <!-- <SSO discoveryProtocol="SAMLDS" discoveryURL="https://wayf.incommonfederation.org/DS/WAYF">SAML2 SAML1</SSO> -->
              <!--
              <SSO>SAML2 SAML1</SSO>
              -->
              <!--
              <SSO entityID="https://openidp.nii.ac.jp/idp/shibboleth"
                    discoveryProtocol="SAMLDS" discoveryURL="https://openidp.nii.ac.jp/DS/WAYF">
                 SAML2 SAML1
              </SSO>
              -->
              <SSO
                  discoveryProtocol="SAMLDS"
                  discoveryURL="{{ .Values.apache.shibboleth.ds_url }}">
                SAML2 SAML1
              </SSO>

              <!-- SAML and local-only logout. -->
              <Logout>SAML2 Local</Logout>

              <!-- Extension service that generates "approximate" metadata based on SP configuration. -->
              <Handler type="MetadataGenerator" Location="/Metadata" signing="false"/>

              <!-- Status reporting service. -->
              <!-- <Handler type="Status" Location="/Status" acl="127.0.0.1 ::1"/> -->
              <Handler type="Status" Location="/Status"/>

              <!-- Session diagnostic service. -->
              <!-- <Handler type="Session" Location="/Session" showAttributeValues="false"/> -->
              <Handler type="Session" Location="/Session" showAttributeValues="true"/>

              <!-- JSON feed of discovery information. -->
              <Handler type="DiscoveryFeed" Location="/DiscoFeed"/>

              <SessionInitiator type="Chaining" Location="/DS" id="DS"
                                isDefault="true">
                   <SessionInitiator type="SAML2" template="bindingTemplate.html"/>
                   <SessionInitiator type="Shib1"/>
                   <SessionInitiator type="Form" template="discoveryTemplate.html" />
  <!--
                  <SessionInitiator type="SAML2" entityID="https://openidp.nii.ac.jp/idp/shibboleth" />
             <SessionInitiator type="SAMLDS" URL="{{ .Values.apache.shibboleth.ds_url }}"/>
  -->
             </SessionInitiator>
          </Sessions>

          <!--
          Allows overriding of error template information/filenames. You can
          also add attributes with values that can be plugged into the templates.
          -->
          <Errors supportContact="rdm_support@nii.ac.jp" helpLocation="/about.html" styleSheet="/shibboleth-sp/main.css"/>
          <!-- <Errors supportContact="EMAIL" logoLocation="/shibboleth-sp/logo.jpg" styleSheet="/shibboleth-sp/main.css"/> -->

          <!-- Example of remotely supplied batch of signed metadata. -->
          <!--
          <MetadataProvider type="XML" uri="http://federation.org/federation-metadata.xml"
                backingFilePath="federation-metadata.xml" reloadInterval="7200">
              <MetadataFilter type="RequireValidUntil" maxValidityInterval="2419200"/>
              <MetadataFilter type="Signature" certificate="fedsigner.pem"/>
          </MetadataProvider>
          <MetadataProvider type="XML" uri="https://metadata.gakunin.nii.ac.jp/gakunin-test-metadata.xml"
                backingFilePath="test-federation-metadata.xml" reloadInterval="7200">
              <MetadataFilter type="RequireValidUntil" maxValidityInterval="1296000"/>
              <MetadataFilter type="Signature" certificate="/etc/shibboleth/gakunin-test-signer-2011.cer"/>
          </MetadataProvider>
          -->

          <MetadataProvider type="XML" uri="https://metadata.gakunin.nii.ac.jp/gakunin-metadata.xml"
                backingFilePath="federation-metadata.xml" reloadInterval="7200">
              <MetadataFilter type="RequireValidUntil" maxValidityInterval="1296000"/>
              <MetadataFilter type="Signature" certificate="/etc/shibboleth/gakunin-signer.cer"/>
          </MetadataProvider>

          <!-- Example of locally maintained metadata. -->
          {{- if hasKey .Values.apache.secretFiles "shibboleth/locally-IdP-metadata.xml" -}}
          <MetadataProvider type="XML" file="locally-IdP-metadata.xml"/>
          {{- end -}}
          <!--
          <MetadataProvider type="XML" file="partner-metadata.xml"/>
          -->

          <!-- InCommon -->
          <!-- <MetadataProvider type="XML" uri="http://md.incommon.org/InCommon/InCommon-metadata.xml"
                            backingFilePath="incommon-idp-metadata.xml" reloadInterval="86400">
              <MetadataFilter type="Signature" certificate="incommon-idp-signature.pem"/>
          </MetadataProvider> -->

          <AttributeResolver type="SimpleAggregation" attributeId="eppn"
                             format="urn:oid:1.3.6.1.4.1.5923.1.1.1.6">
            <Entity>https://sptest.cg.gakunin.jp/idp/shibboleth</Entity>
            <saml2:Attribute
                xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"
                Name="urn:oid:1.3.6.1.4.1.5923.1.5.1.1"
                NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
                FriendlyName="isMemberOf"/>
            <saml2:Attribute
                xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion"
                Name="urn:oid:1.3.6.1.4.1.5923.1.1.1.10"
                NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:uri"
                FriendlyName="eduPersonTargetedID"/>
          </AttributeResolver>

          <!-- Map to extract attributes from SAML assertions. -->
          <AttributeExtractor type="XML" validate="true" reloadChanges="false" path="attribute-map.xml"/>

          <!-- Use a SAML query if no attributes are supplied during SSO. -->
          <AttributeResolver type="Query" subjectMatch="true"/>

          <!-- Default filtering policy for recognized attributes, lets other data pass. -->
          <AttributeFilter type="XML" validate="true" path="attribute-policy.xml"/>

          <!-- Simple file-based resolver for using a single keypair. -->
          <CredentialResolver type="File" key="sp-key.pem" certificate="sp-cert.pem"/>

          <!--
          The default settings can be overridden by creating ApplicationOverride elements (see
          the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApplicationOverride topic).
          Resource requests are mapped by web server commands, or the RequestMapper, to an
          applicationId setting.

          Example of a second application (for a second vhost) that has a different entityID.
          Resources on the vhost would map to an applicationId of "admin":
          -->
          <!--
          <ApplicationOverride id="admin" entityID="https://admin.example.org/shibboleth"/>
          -->
      </ApplicationDefaults>

      <!-- Policies that determine how to process and authenticate runtime messages. -->
      <SecurityPolicyProvider type="XML" validate="true" path="security-policy.xml"/>

      <!-- Low-level configuration about protocols and bindings available for use. -->
      <ProtocolProvider type="XML" validate="true" reloadChanges="false" path="protocols.xml"/>

  </SPConfig>
httpd/conf.d/shib.conf: |-
  LoadModule mod_shib /usr/lib64/shibboleth/mod_shib_24.so

  RemoteIPHeader X-Forwarded-For
  RemoteIPInternalProxy 10.0.0.0/8
  RemoteIPInternalProxy 172.16.0.0/12
  RemoteIPInternalProxy 192.168.0.0/16

  <IfModule log_config_module>
      LogFormat "%a %{X-Forwarded-For}i %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
      SetEnvIfNoCase User-Agent "kube-probe/*" dontlog
  </IfModule>

  <VirtualHost *:{{ .Values.service.internalPort }}>
    ServerName health
    LoadModule status_module "modules/mod_status.so"

    <Location "/healthz">
      LogLevel crit
      Require ip 10.0.0.0/8
      Require local
      SetHandler server-status
    </Location>
  </VirtualHost>
  <VirtualHost *:{{ .Values.service.internalPort }}>
    ServerName https://{{ required "casDomain must be set" .Values.casDomain }}:443
    UseCanonicalName On
    ServerAdmin admin@osf.io

    # Mitigate clickjacking
    # https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options
    Header set X-Frame-Options "deny"

    ProxyRequests off

    # the google health check must have a 200 from /
    RewriteEngine On
    RewriteCond %{HTTP_USER_AGENT} "googlehc" [NC]
    SetEnvIfNoCase User-Agent "googlehc" dontlog
    RewriteRule ^/ - [L,R=200]

    # Redirect HTTP to HTTPS
    RewriteCond %{HTTP:X-Forwarded-Proto} =http [NC]
    RewriteRule . https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]

    <Location />
      # ShibDisable on
      ShibRequestSetting REMOTE_ADDR X-Forwarded-For

      ProxyPass http://127.0.0.1:{{ .Values.service.externalPort }}/
      ProxyPassReverse http://127.0.0.1:{{ .Values.service.externalPort }}/
    </Location>

    <Location /login>
      <If "%{HTTP_REFERER} !~ m#^https://{{ .Values.casDomain }}/#">
        AuthType shibboleth
        ShibRequestSetting REMOTE_ADDR X-Forwarded-For
        ShibRequestSetting requireSession 1

        <RequireAll>
          require shibboleth
          {{- if (index .Values.apache "additionalRequirements") }}
          {{- .Values.apache.additionalRequirements | nindent 10 }}
          {{- end }}
        </RequireAll>

        # https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPSpoofChecking
        # - Jetty 9 drops AJP Support (https://bugs.eclipse.org/bugs/show_bug.cgi?id=425244)
        ShibUseEnvironment off
        ShibUseHeaders on
      </If>

      ProxyPass http://127.0.0.1:{{ .Values.service.externalPort }}/login
      ProxyPassReverse http://127.0.0.1:{{ .Values.service.externalPort }}/login
    </Location>

    <Location /Shibboleth.sso>
      ProxyPass !
      SetHandler shib
    </Location>

    <Location /js/embedded-wayf_config.js>
      ProxyPass !
      Require all granted
    </Location>
    Alias /js/embedded-wayf_config.js "/etc/shibboleth/embedded-wayf_config.js"
    <Location /js/embedded-wayf_disp.js>
      ProxyPass !
      Require all granted
    </Location>
    Alias /js/embedded-wayf_disp.js "/etc/shibboleth/embedded-wayf_disp.js"
  </VirtualHost>
shibboleth/discoveryTemplate.html: |-
  <html>
          <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>{{ .Values.osfPageName }} | Sign In</title>
    <link rel="stylesheet" href="/css/cas.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.1/html5shiv.js" type="text/javascript"></script>
    <![endif]-->
  
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,300,700' rel='stylesheet' type='text/css'>
  </head>
          <body>
  <body id="cas">
      <div id="container">
          </br>
          <header>
              
              <a id="logo" href="https://{{ .Values.osfDomain }}/" title="GakuNin RDM Sign In">GakuNin RDM</a>
              </br>
              <div align="center" class="center">
                  <span id="title">GakuNin RDM</span>
              </div>
          </header>
      </br>
  
  
  <div align="center" width="50%">
  
  <h2>所属機関の選択</h2>
  
  <p>
  GakuNin RDMを利用するため、所属機関で認証する必要があります。所属機関を選択してください。
  <br />
  ※このページを表示して時間が経過している場合は、再読み込みしてから所属機関を選択してください。正しいページに戻れない場合があります。
  </p>
  </div>
  
  <div id="content" style="width: 50%; overflow: visible;">
  
  <div class="box" id="login">
  
  <!-- EMBEDDED-WAYF-START -->
  <script type="text/javascript" src="/js/embedded-wayf_disp.js"></script>
  <script type="text/javascript" src="/js/embedded-wayf_config.js"></script>
  <script type="text/javascript">
  wayf_sp_samlDSURL = "<shibmlp action/>".replace(/&#58;/g, ":");
  <shibmlpif target>
  wayf_return_url = "<shibmlp target/>".replace(/&#58;/g, ":");
  </shibmlpif>
  //wayf_show_remember_checkbox = true;
  //wayf_force_remember_for_session = true;
  wayf_auto_login = true;
  </script>
  
  <script type="text/javascript" charset="UTF-8"><!--
    document.write('<script type="text/javascript" src="{{ .Values.apache.shibboleth.embedded_ds }}?' + (new Date().getTime()) + '"></scr'+'ipt>');
  //-->
  </script>
  
  <noscript>
    <!-- 
    Fallback to Shibboleth DS session initiator for non-JavaScript users 
    You should set the value of the target GET parameter to an URL-encoded 
    absolute URL that points to a Shibboleth protected web page where the user 
    is logged in into your application.
    -->
    <p>
      <strong>ログイン:</strong> あなたのブラウザでJavaScriptが無効になっています。学認(運用フェデレーション)に参加しているIdPを選択する場合は<a href="/Shibboleth.sso/Login?target=<shibmlp target/>">こちらをクリックしてください</a>。
    </p>
  </noscript>
  
  <!-- EMBEDDED-WAYF-END -->
  
  </div>
  
  <noscript>
  <p>もしくは以下のテキストボックスに所属機関IdPのentityIDを入力して[選択]ボタンを押してください。</p>
                  <form method="GET" action="<shibmlp action/>">
              <shibmlpif target>
                  <input type="hidden" name="target" value="<shibmlp target/>"/>
              </shibmlpif>
  
              <shibmlpif acsIndex>
                  <input type="hidden" name="acsIndex" value="<shibmlp acsIndex/>"/>
              </shibmlpif>
  
              <shibmlpif isPassive>
                  <input type="hidden" name="isPassive" value="<shibmlp isPassive/>"/>
              </shibmlpif>
  
              <shibmlpif forceAuthn>
                  <input type="hidden" name="forceAuthn" value="<shibmlp forceAuthn/>"/>
              </shibmlpif>
  
              <shibmlpif authnContextClassRef>
                  <input type="hidden" name="authnContextClassRef" value="<shibmlp authnContextClassRef/>"/>
              </shibmlpif>
  
              <shibmlpif authnContextComparison>
                  <input type="hidden" name="authnContextComparison" value="<shibmlp authnContextComparison/>"/>
              </shibmlpif>
              
                      <input type="text" name="entityID" value="<shibmlp entityID/>">
                      <input type="submit" value="選択"/>
                  </form>
  </noscript>
                  
                  <shibmlpif entityID>
                  <p>The system was unable to determine how to proceed using the value you supplied.</p>
                  </shibmlpif>
  
      <div class="row" style="text-align: center;">
          <hr>
          <a id="back-to-osf" href="https://{{ .Values.osfDomain }}/">Back to GakuNin RDM</a></br>
      </div>
  </div>
  
  <footer>
      <div class="container copyright" style="text-size: 16px">
      <div class="row">
          <div class="col-md-12">
              <script>
              document.write('<p><font size="+1">Copyright &copy; 2017-' + (new Date().getUTCFullYear()) + ' <a href="http://www.nii.ac.jp/">National&nbsp;Institute&nbsp;of&nbsp;Informatics</a></font></p>');
              </script>
          </div>
      </div>
      </div><!-- end container copyright -->
  </footer>
  
  </div> <!-- END #container -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/headjs/1.0.3/head.min.js"></script>
  
  <script type="text/javascript" src="/js/cas.js"></script>
  
  
  </body>
  </html>
shibboleth/embedded-wayf_config.js: |-
  // To use this JavaScript, please access:
  // https://ds.gakunin.nii.ac.jp/WAYF/embedded-wayf.js/snippet.html
  // and copy/paste the resulting HTML snippet to an unprotected web page that 
  // you want the embedded WAYF to be displayed
  
  
  //////////////////// ESSENTIAL SETTINGS ////////////////////
  
  // URL of the WAYF to use
  // Examples: "https://wayf.switch.ch/SWITCHaai/WAYF", "https://wayf-test.switch.ch/aaitest/WAYF";
  // [Mandatory]
  var wayf_URL = "{{ .Values.apache.shibboleth.ds_url }}";
  
  // EntityID of the Service Provider that protects this Resource
  // Examples: "https://econf.switch.ch/shibboleth", "https://dokeos.unige.ch/shibboleth"
  // [Mandatory]
  var wayf_sp_entityID = "https://{{ .Values.casDomain }}/shibboleth-sp";
  
  // Shibboleth Service Provider handler URL
  // Examples: "https://point.switch.ch/Shibboleth.sso", "https://rr.aai.switch.ch/aaitest/Shibboleth.sso"
  // [Mandatory, if wayf_use_discovery_service = false]
  //wayf_use_discovery_service = true;
  var wayf_sp_handlerURL = "https://{{ .Values.casDomain }}/Shibboleth.sso";
  
  // URL on this resource that the user shall be returned to after authentication
  // Examples: "https://econf.switch.ch/aai/home", "https://olat.uzh.ch/my/courses"
  // [Mandatory]
  var wayf_return_url = "https://{{ .Values.casDomain }}/login?service=https://{{ .Values.osfDomain }}/";
  
  
  //////////////////// RECOMMENDED SETTINGS ////////////////////
  
  // Width of the embedded WAYF in pixels or "auto"
  // This is the width of the content only (without padding and border). 
  // Add 2 x (10px + 1px) = 22px for padding and border to get the actual 
  // width of everything that is drawn.
  // [Optional, default: "auto"]
  // var wayf_width = 430;
  
  // Height of the embedded WAYF in pixels or "auto"
  // This is the height of the content only (without padding and border). 
  // Add 2 x (10px + 1px) = 22px for padding and border to get the actual 
  // height of everything that is drawn.
  // [Optional, default: "auto"]
  var wayf_height = "auto";
  
  // Whether to show the checkbox to remember settings for this session
  // [Optional, default: true]
  var wayf_show_remember_checkbox = false;
  
  // Force the user's Home Organisation selection to be remembered for the
  // current browser session. If wayf_show_remember_checkbox is true
  // the checkbox will be shown but will be read only.
  // WARNING: Only use this feature if you know exactly what you are doing
  //          This option will cause problems that are difficult to find 
  //          in case they accidentially select a wrong Home Organisation
  // [Optional, false]
  var wayf_force_remember_for_session = false;
  
  // Logo size
  // Choose whether the small or large logo shall be used
  // [Optional, default: true]
  var wayf_use_small_logo = true;
  var wayf_hide_logo = true;
  var wayf_show_categories = false;
  var wayf_overwrite_intro_text="";
  
  // Font size
  // [Optional, default: 12]
  var wayf_font_size = 11;
  
  // Font color
  // [Optional, default: #000000]
  var wayf_font_color = '#000000';
  
  // Border color
  // [Optional, default: #00247D]
  var wayf_border_color = '#00247D';
  
  // Background color
  // [Optional, default: #F4F7F7]
  var wayf_background_color = '#F4F7F7';
  
  // Whether to automatically log in user if he has a session/permanent redirect
  // cookie set at central wayf
  // [Optional, default: true]
  var wayf_auto_login = false;
  
  // Whether to hide the WAYF after the user was logged in
  // This requires that the _shib_session_* cookie is set when a user 
  // could be authenticated, which is the default case when Shibboleth is used.
  // For other Service Provider implementations have a look at the setting
  // wayf_check_login_state_function that allows you to customize this
  // [Optional, default: false]
  var wayf_hide_after_login = false;
  
  // Whether or not to show the categories in the drop-down list
  // Possible values are: true or false
  // [Optional, default: true]
  var wayf_show_categories =  false;
  
  // Most used Identity Providers will be shown as top category in the drop down
  // list if this feature is used.
  // [Optional, commented out by default]
  // var wayf_most_used_idps =  new Array("https://aai-logon.unibas.ch/idp/shibboleth", "https://aai.unil.ch/idp/shibboleth");
  
  // Categories of Identity Provider that shall not be shown
  // Possible values are: "hokkaido","tohoku","kanto","chubu","kinki","chugoku","shikoku","kyushu","others", "all"
  // Example of how to hide categories
  // var wayf_hide_categories =  new Array("other", "library");
  // [Optional, commented out by default]
  // var wayf_hide_categories =  new Array();
  var wayf_hide_categories =  new Array("all");
  
  // EntityIDs of Identity Provider whose category is hidden but that shall be shown anyway
  // If this array is not empty, wayf_show_categories will be disabled because
  // otherwise, unhidden IdPs may be displayed in the wrong category
  // Example of how to unhide certain Identity Providers
  // var wayf_unhide_idps = new Array("https://aai-login.uzh.ch/idp/shibboleth");
  // [Optional, commented out by default]
  // var wayf_unhide_idps = new Array();
  var wayf_unhide_idps = new Array("https://openidp.nii.ac.jp/idp/shibboleth", "https://idp.rdm.nii.ac.jp/idp/shibboleth");
  
  // EntityIDs of Identity Provider that shall not be shown at all
  // Example of how to hide certain Identity Provider
  // var wayf_hide_idps = new Array("https://idp.unige.ch/idp/shibboleth", "https://lewotolo.switch.ch/idp/shibboleth");
  // [Optional, commented out by default]
  // var wayf_hide_idps = new Array();
  
  //////////////////// ADVANCED SETTINGS ////////////////////
  
  // Use the SAML2/Shibboleth 2 Discovery Service protocol where
  // the user is sent back to the Service Provider after selection
  // of his Home Organisation.
  // This is true by default and it should only be uncommented and set to false
  // if there is a good reason why to use the old and deprecated Shibboleth WAYF
  // protocol instead.
  // [Optional, default: commented out]
  // var wayf_use_discovery_service = false;
  
  // Session Initiator URL of the Service Provider
  // Examples: "https://econf.switch.ch/Shibboleth.sso/DS", "https://dokeos.unige.ch/Shibboleth.sso/DS"
  // This will implicitely be set to wayf_sp_samlDSURL = wayf_sp_handlerURL + "/DS";
  // [Optional, if wayf_use_discovery_service = true 
  //  or if wayf_additional_idps is not empty, default: commented out]
  // var wayf_sp_samlDSURL = wayf_sp_handlerURL + "/Login";
  
  // Default IdP to preselect when central WAYF couldn't guess IdP either
  // This is usually the case the first time ever a user accesses a resource
  // [Optional, default: commented out]
  // var wayf_default_idp = "https://aai.switch.ch/idp/shibboleth";
  
  // Set a custom Assertion Consumer URL instead of
  // the default wayf_sp_handlerURL + '/SAML/POST'
  // Only relevant if wayf_use_discovery_service is false
  // Examples: "https://olat.uzh.ch/shib/samlaa", 
  // This will implicitely be set to wayf_sp_samlACURL = wayf_sp_handlerURL + "/SAML/POST";
  // "https://foodle.feide.no/simplesaml/shib13/sp/AssertionConsumerService.php"
  // [Optional, commented out by default]
  // var wayf_sp_samlACURL = "https://maclh.switch.ch/foo/bar";
  
  // Overwites the text of the checkbox if
  // wayf_show_remember_checkbox is set to true
  // [Optional, commented out by default]
  // var wayf_overwrite_checkbox_label_text = 'Save setting for today';
  
  // Overwrites the text of the submit button
  // [Optional, commented out by default]
  // var wayf_overwrite_submit_button_text = 'Go';
  
  // Overwrites the intro text above the drop-down list
  // [Optional, commented out by default]
  // var wayf_overwrite_intro_text = 'Select your Home Organisation to log in';
  
  // Overwrites the category name of the most used IdP category in the drop-down list
  // [Optional, commented out by default]
  // var wayf_overwrite_most_used_idps_text = 'Most popular';
  
  
  // Whether to hide the WAYF after the user was logged in
  // This requires that the _shib_session_* cookie is set when a user 
  // could be authenticated
  // If you want to hide the embedded WAYF completely, uncomment
  // the property and set it to "". This then won't draw anything
  // [Optional, default commented out: You are already logged in]
  // var wayf_logged_in_messsage = "";
  
  // Provide the name of a JavaScript function that checks whether the user
  // already is logged in. The function should return true if the user is logged
  // in or false otherwise. If the user is logged in, the Embedded WAYF will
  // hide itself or draw a custom message depending on the 
  // setting wayf_logged_in_messsage
  // The function you specify has of course to be implemented by yourself!
  // [Optional, commented out by default]
  // var wayf_check_login_state_function = function() { 
  // if (# specify user-is-logged-in condition#)
  //   return true;
  // else 
  //   return false;
  // }
  
  // EntityIDs, Names and SSO URLs of Identity Providers from other federations 
  // that shall be added to the drop-down list
  // The IdPs will be displayed in the sequence they are defined
  // [Optional, commented out by default]
  // var wayf_additional_idps = [ ];
  // Example of how to add Identity Provider from other federations
  // var wayf_additional_idps = [ 
  //        
  //        {name:"International University X",
  //        entityID:"urn:mace:switch.ch:SWITCHaai:example.university.org",
  //        SAML1SSOurl:"https://int.univ.org/shibboleth-idp/SSO"},
  //
  //        {name:"Some Other University",
  //        entityID:"https://other.univ.edu/idp/shibboleth",
  //        SAML1SSOurl:"https://other.univ.edu/shibboleth-idp/SSO"},
  // ];
  
  var wayf_additional_idps = [
        {name:"OpenIdP",
        entityID:"https://openidp.nii.ac.jp/idp/shibboleth",
        SAML1SSOurl:"https://openidp.nii.ac.jp/idp/profile/Shibboleth/SSO"},
  ];
  
  
  // The list which is the target of incremental search is extracted to IdP acquired by DiscpFeed
  // URL of DiscpFeed is set up
  // var wayf_discofeed_url = "https://point.switch.ch/Shibboleth.sso/DiscoFeed";
  // [Optional, commented out by default]
  // var wayf_discofeed_url = "";
  
  // The path of Cookie created by SP is set. As for default configuration, 
  // the path of an access place is set.
  // var wayf_sp_cookie_path = "/";
  // [Optional, commented out by default]
  // var wayf_sp_cookie_path = "";
  var wayf_sp_cookie_path = "/";
  
  // Height of the embedded WAYF IdP List in pixels
  // [Optional, default: 150]
  var wayf_list_height = 350;
  
  
  //////////////////// ADDITIONAL CSS CUSTOMIZATIONS ////////////////////
  
  // To further customize the appearance of the Embedded WAYF you could
  // define CSS rules for the following CSS IDs that are used within the 
  // Embedded WAYF:
  // #wayf_div                     - Container for complete Embedded WAYF
  // #wayf_logo_div                - Container for logo
  // #wayf_logo                    - Image for logo
  // #wayf_intro_div               - Container of drop-down list intro label
  // #wayf_intro_label             - Label of intro text
  // #IdPList                      - The form element
  // #user_idp                     - Select element for drop-down list
  // #wayf_remember_checkbox_div   - Container of checkbox and its label
  // #wayf_remember_checkbox       - Checkbox for remembering settings for session
  // #wayf_remember_checkbox_label - Text of checkbox
  // #wayf_submit_button           - Submit button
  //
  // Use these CSS IDs carefully and at own risk because future updates could
  // interfere with the rules you created and the IDs may change without notice!
  
  
  //-->
{{- end -}}
{{- define "cas.jetty.inlineconfigs" }}
cas.properties: |-
  #
  # Licensed to Apereo under one or more contributor license
  # agreements. See the NOTICE file distributed with this work
  # for additional information regarding copyright ownership.
  # Apereo licenses this file to you under the Apache License,
  # Version 2.0 (the "License"); you may not use this file
  # except in compliance with the License.  You may obtain a
  # copy of the License at the following location:
  #
  #   http://www.apache.org/licenses/LICENSE-2.0
  #
  # Unless required by applicable law or agreed to in writing,
  # software distributed under the License is distributed on an
  # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  # KIND, either express or implied.  See the License for the
  # specific language governing permissions and limitations
  # under the License.
  #


  ####
  #### OSF CAS
  ####
  #### This section "OSF CAS" contains new properties for OSF-oriented CAS customization.
  ####

  ##
  # Google Analytics
  #
  google.analytics.id=${GOOGLE_ANALYTICS_ID:}
  google.analytics.autoLink=${GOOGLE_ANALYTICS_AUTOLINK:}

  ##
  # CAS Login and Logout URLs
  #
  cas.osf.login.url=/login?
  cas.logout.url=/logout
  cas.institution.login.url=/login?campaign=institution

  ##
  # Login Rate Limiting
  #
  cas.rateLimiting.failureRangeInSeconds=${CAS_RL_FAILURE_RANGE_IN_SECONDS:1}
  cas.rateLimiting.failureThreshold=${CAS_RL_FAILURE_THRESHOLD:5}
  cas.rateLimiting.usernameParameter=${CAS_RL_USERNAME_PARAMETER:username}
  cas.rateLimiting.startDelay=${CAS_RL_START_DELAY:1000}
  cas.rateLimiting.repeatInterval=${CAS_RL_REPEAT_INTERVAL:5000}

  ##
  # Authentication Delegation: General
  #
  delegation.redirect.uri=https://{{ .Values.casDomain }}/login
  #
  ##
  # Authentication Delegation: Clients
  #
  # CAS Client: California Lutheran University
  cas.callutheran.login.url=${CAS_CALLUTHERAN_LOGIN_URL:https://sso.callutheran.edu/cas/login}
  cas.callutheran.client.name=${CAS_CALLUTHERAN_CLIENT_NAME:callutheran}
  cas.callutheran.cas.protocol=${CAS_CALLUTHERAN_CAS_PROTOCOL:SAML}
  #
  # CAS Client: Ferris State University
  cas.ferris.login.url=${CAS_FERRIS_LOGIN_URL:https://lpcas.ferris.edu/cas-web/login}
  cas.ferris.client.name=${CAS_FERRIS_CLIENT_NAME:ferris}
  cas.ferris.cas.protocol=${CAS_FERRIS_CAS_PROTOCOL:CAS20}
  #
  # CAS Client: Oklahoma State University
  cas.okstate.login.url=${CAS_OKSTATE_LOGIN_URL:https://stgcas.okstate.edu/cas/login}
  cas.okstate.client.name=${CAS_OKSTATE_CLIENT_NAME:okstate}
  cas.okstate.cas.protocol=${CAS_OKSTATE_CAS_PROTOCOL:SAML}
  #
  # OAuth Client: ORCiD
  oauth.orcid.authorize.url=${OAUTH_ORCID_AUTHORIZATION_URL:https://orcid.org/oauth/authorize}
  oauth.orcid.token.url=${OAUTH_ORCID_TOKEN_URL:https://pub.orcid.org/oauth/token}
  oauth.orcid.client.id=${OAUTH_ORCID_CLIENT_ID:}
  oauth.orcid.client.secret=${OAUTH_ORCID_CLIENT_SECRET:}
  oauth.orcid.member=${OAUTH_ORCID_MEMBER:false}
  oauth.orcid.scope=${OAUTH_ORCID_SCOPE:/authenticate}

  ##
  # OSF URLs
  #
  osf.url=https://{{ .Values.osfDomain }}/
  osf.institutionLogin.url=https://{{ .Values.osfDomain }}/login/?campaign=institution
  osf.resendConfirmation.url=https://{{ .Values.osfDomain }}/resend/
  osf.forgotPassword.url=https://{{ .Values.osfDomain }}/forgotpassword/
  osf.createAccount.url=https://{{ .Values.osfDomain }}/register/

  ##
  # API URLs
  #
  osf.api.institutions.auth.url=https://{{ .Values.apiDomain }}/v2/institutions/auth/
  # The encryption secret key. By default, must be a octet string of size 256.
  osf.api.institutions.auth.jweSecret=${OSF_JWE_SECRET}
  osf.api.institutions.auth.jwtSecret=${OSF_JWT_SECRET}
  osf.api.institutions.auth.xslLocation=file:/etc/cas/institutions-auth.xsl

  ##
  # Open Science Framework Postgres Database
  #
  osf.database.driverClass=org.postgresql.Driver
  osf.database.url=${OSF_DB_URL:jdbc:postgresql://127.0.0.1/osf?targetServerType=master}
  osf.database.user=${OSF_DB_USER:postgres}
  osf.database.password=${OSF_DB_PASSWORD:}
  osf.database.hibernate.dialect=org.hibernate.dialect.PostgreSQL82Dialect

  ##
  # OAuth Provider
  #
  # OAuth Access Token session length in seconds
  oauth.accessTokenDuration=3600
  oauth.loginUrl=https://{{ .Values.casDomain }}/login



  ####
  #### Central Authentication Service (CAS)
  ####
  #### This section "Central Authentication Service (CAS)" contains default properties from jasig/apereo.
  ####

  server.name=https://{{ .Values.casDomain }}
  server.prefix=${server.name}

  # Spring Security's EL-based access rules for the /status URI of CAS that exposes health check information
  cas.securityContext.status.access=hasIpAddress('127.0.0.1')

  # Spring Security's EL-based access rules for the /statistics URI of CAS that exposes stats about the CAS server
  cas.securityContext.statistics.access=hasIpAddress('127.0.0.1')

  cas.themeResolver.defaultThemeName=cas-theme-default

  # Path prefix for where views are to be found
  # cas.viewResolver.defaultViewsPathPrefix=/WEB-INF/view/jsp/default/ui/

  # Location of the Spring xml config file where views may be collected
  # cas.viewResolver.xmlFile=/META-INF/spring/views.xml

  ##
  # Unique CAS node name
  # host.name is used to generate unique Service Ticket IDs and SAMLArtifacts.  This is usually set to the specific
  # hostname of the machine running the CAS node, but it could be any label so long as it is unique in the cluster.
  host.name={{ .Values.casDomain }}

  ##
  # Database flavors for Hibernate
  #
  database.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
  database.hibernate.batchSize=1
  database.hibernate.showSql=false
  database.driverClass=org.postgresql.Driver
  database.url=${DATABASE_URL}
  database.user=${DATABASE_USER}
  database.password=${DATABASE_PASSWORD}

  ##
  # CAS SSO Cookie Generation & Security
  # See https://github.com/mitreid-connect/json-web-key-generator
  #
  # Do note that the following settings MUST be generated per deployment.
  #
  # Defaults at spring-configuration/ticketGrantingTicketCookieGenerator.xml
  # The encryption secret key. By default, must be a octet string of size 256.
  tgc.encryption.key=${TGC_ENCRYPTION_KEY}
  #
  # The signing secret key. By default, must be a octet string of size 512.
  tgc.signing.key=${TGC_SIGNING_KEY}
  #
  # Allow non-secure cookie generation, Must set this `true` for production.
  tgc.cookie.secure=true
  #
  # Do not allow client side script to access the cookie, MUST set this `true` for production.
  tgc.cookie.httponly=true

  ##
  # CAS Session Cookie
  #
  jsession.cookie.secure=true
  jsession.cookie.httponly=true

  ##
  # CAS Logout Behavior
  # WEB-INF/cas-servlet.xml
  #
  # Specify whether CAS should redirect to the specified service parameter on /logout requests
  cas.logout.followServiceRedirects=true

  ##
  # CAS Cached Attributes Timeouts
  # Controls the cached attribute expiration policy
  #
  # Notes the duration in which attributes will be kept alive
  # cas.attrs.timeToExpireInHours=2

  ##
  # Single Sign-On Session
  #
  # Indicates whether an SSO session should be created for renewed authentication requests.
  # create.sso.renewed.authn=true
  #
  # Indicates whether an SSO session can be created if no service is present.
  # create.sso.missing.service=true

  ##
  # Spring Webflow Web Application Session
  # Define the settings that are required to encrypt and persist the CAS web application session.
  # See the cas-servlet.xml file to understand how these properties are used.
  #
  # cas.webflow.cipher.alg=AES
  # cas.webflow.cipher.mode=CBC
  # cas.webflow.cipher.padding=PKCS7
  # cas.webflow.keystore=classpath:/etc/keystore.jceks
  # cas.webflow.keystore.type=JCEKS
  # cas.webflow.keystore.password=changeit
  # cas.webflow.keyalias=aes128
  # cas.webflow.keypassword=changeit

  ##
  # Single Sign-On Session Timeouts
  # Defaults sourced from WEB-INF/spring-configuration/ticketExpirationPolices.xml
  #
  # Maximum session timeout - TGT will expire in maxTimeToLiveInSeconds regardless of usage
  # tgt.maxTimeToLiveInSeconds=28800
  #
  # Idle session timeout -  TGT will expire sooner than maxTimeToLiveInSeconds if no further requests
  # for STs occur within timeToKillInSeconds
  # tgt.timeToKillInSeconds=7200
  #
  # Long term authentication session length in seconds (30 days)
  tgt.rememberMeDuration=${TGT_REMEMBER_ME_DURATION:2592000}

  ##
  # Service Ticket Timeout
  # Default sourced from WEB-INF/spring-configuration/ticketExpirationPolices.xml
  #
  # Service Ticket timeout - typically kept short as a control against replay attacks, default is 10s.  You'll want to
  # increase this timeout if you are manually testing service ticket creation/validation via tamperdata or similar tools
  st.timeToKillInSeconds=${ST_TIME_TO_KILL_IN_SECONDS:60}

  ##
  # Http Client Settings
  #
  # The http client read timeout in milliseconds
  # http.client.read.timeout=5000
  #
  # The http client connection timeout in milliseconds
  # http.client.connection.timeout=5000
  #
  # The http client truststore file, in addition to the default's
  #http.client.truststore.file=classpath:truststore.jks
  #
  # The http client truststore's password
  # http.client.truststore.psw=changeit

  ##
  # Single Logout Out Callbacks
  # Default sourced from WEB-INF/spring-configuration/argumentExtractorsConfiguration.xml
  #
  # To turn off all back channel SLO requests set this to true
  slo.callbacks.disabled=true
  #
  # To send callbacks to endpoints synchronously, set this to false
  # slo.callbacks.asynchronous=true

  ##
  # CAS Protocol Security Filter
  #
  # Are multi-valued parameters accepted?
  # cas.http.allow.multivalue.params=false
  #
  # Define the list of request parameters to examine for sanity
  # cas.http.check.params=ticket,service,renew,gateway,warn,target,SAMLart,pgtUrl,pgt,pgtId,pgtIou,targetService
  #
  # Define the list of request parameters only allowed via POST
  cas.http.allow.post.params=password,oneTimePassword

  ##
  # JSON Service Registry
  #
  # Directory location where JSON service files may be found.
  service.registry.config.location=file:/etc/cas/services

  ##
  # Service Registry Periodic Reloading Scheduler
  # Default sourced from WEB-INF/spring-configuration/applicationContext.xml
  #
  # Force a startup delay of 2 minutes.
  # service.registry.quartz.reloader.startDelay=120000
  #
  # Reload services every 2 minutes
  # service.registry.quartz.reloader.repeatInterval=120000

  ##
  # Log4j
  # Default sourced from WEB-INF/spring-configuration/log4jConfiguration.xml:
  #
  # It is often time helpful to externalize log4j.xml to a system path to preserve settings between upgrades.
  log4j.config.location=file:/etc/cas/log4j2.xml

  ##
  # Metrics
  # Default sourced from WEB-INF/spring-configuration/metricsConfiguration.xml:
  #
  # Define how often should metric data be reported. Default is 30 seconds.
  metrics.refresh.internal=${METRICS_REFRESH_INTERNAL:9999s}

  ##
  # Encoding
  #
  # Set the encoding to use for requests. Default is UTF-8
  # httprequest.web.encoding=UTF-8
  #
  # Default is true. Switch this to "false" to not enforce the specified encoding in any case,
  # applying it as default response encoding as well.
  # httprequest.web.encoding.force=true

  ##
  # Reports
  #
  # Setting to whether include the ticket granting ticket id in the report
  # sso.sessions.include.tgt=false

  ##
  # Password Policy
  #
  # Warn all users of expiration date regardless of warningDays value.
  # password.policy.warnAll=false
  #
  # Threshold number of days to begin displaying password expiration warnings.
  # password.policy.warningDays=30
  #
  # URL to which the user will be redirected to change the password.
  # password.policy.url=https://password.example.edu/change
log4j2.xml: |-
  <?xml version="1.0" encoding="UTF-8" ?>
  <Configuration monitorInterval="60">
      <Appenders>
          <Console name="Console" target="SYSTEM_OUT">
              <PatternLayout pattern="%d %p [%c] - &lt;%m&gt;%n" />
          </Console>
          <Raven name="Sentry">
              <ThresholdFilter level="ERROR" onMatch="ACCEPT" onMismatch="DENY" />
              <DSN>{{ .Values.sentryDSN }}</DSN>
          </Raven>
      </Appenders>
      <Loggers>
          <Logger name="io.cos" level="info" additivity="false">
              <AppenderRef ref="Console" />
          </Logger>
          <Logger name="org.jasig" level="info" additivity="false">
              <AppenderRef ref="Console" />
          </Logger>
          <Logger name="perfStatsLogger" level="off" additivity="false">
              <AppenderRef ref="Console" />
          </Logger>
          <Root level="warn">
              <AppenderRef ref="Console" />
              <AppenderRef ref="Sentry" />
          </Root>
      </Loggers>
  </Configuration>
services/cas.json: |-
  {
    "@class" : "org.jasig.cas.services.RegexRegisteredService",
    "id" : 983219871349823,
    "name" : "",
    "description" : "",
    "serviceId" : "^https://{{ .Values.casDomain | replace "." "\\\\." }}/.*",
    "evaluationOrder": "2000",
    "logo": "",
    "attributeReleasePolicy" : {
      "@class" : "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
      "allowedAttributes" : [ "java.util.ArrayList", [ "givenName", "familyName" ] ]
    },
    "properties" : {
      "@class": "java.util.HashMap",
      "title": {
        "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
        "values": [
          "java.util.HashSet",
          [
            "Open Science Framework"
          ]
        ]
      },
      "titleAbbr": {
        "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
        "values": [
          "java.util.HashSet",
          [
            "OSF"
          ]
        ]
      }
    }
  }
services/oauth2.json: |-
  {
    "@class" : "org.jasig.cas.support.oauth.services.OAuthCallbackAuthorizeService",
    "id" : 983450982340993434,
    "name" : "",
    "description" : "",
    "serviceId" : "^https://{{ .Values.casDomain | replace "." "\\\\." }}/oauth2/callbackAuthorize",
    "evaluationOrder": "1000",
    "properties" : {
      "@class": "java.util.HashMap",
      "title": {
        "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
        "values": [
          "java.util.HashSet",
          [
            "Open Science Framework"
          ]
        ]
      },
      "titleAbbr": {
        "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
        "values": [
          "java.util.HashSet",
          [
            "OSF"
          ]
        ]
      }
    }
  }
services/osf-campaigns-erpc.json: |-
  {
      "@class": "org.jasig.cas.services.RegexRegisteredService",
      "id": 203948234207232,
      "name": "Election Research<br>Preacceptance Competition",
      "description": "",
      "serviceId": "^https://{{ .Values.osfDomain | replace "." "\\\\." }}/erpc/.*",
      "logo": "",
      "evaluationOrder": 1000,
      "attributeReleasePolicy": {
          "@class": "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
          "allowedAttributes": [
              "java.util.ArrayList", [
                  "given-names",
                  "family-name"
              ]
          ]
      },
      "properties": {
          "@class": "java.util.HashMap",
          "title": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "Open Science Framework"
                  ]
              ]
          },
          "titleAbbr": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "OSF"
                  ]
              ]
          },
          "registerUrl": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "?campaign=erpc"
                  ]
              ]
          }
      }
  }
services/osf-campaigns-prereg.json: |-
  {
      "@class": "org.jasig.cas.services.RegexRegisteredService",
      "id": 203948234207231,
      "name": "Preregistration Challenge",
      "description": "",
      "serviceId": "^https://{{ .Values.osfDomain | replace "." "\\\\." }}/prereg/.*",
      "logo": "",
      "evaluationOrder": 1000,
      "attributeReleasePolicy": {
          "@class": "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
          "allowedAttributes": [
              "java.util.ArrayList", [
                  "given-names",
                  "family-name"
              ]
          ]
      },
      "properties": {
          "@class": "java.util.HashMap",
          "title": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "Open Science Framework"
                  ]
              ]
          },
          "titleAbbr": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "OSF"
                  ]
              ]
          },
          "registerUrl": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "?campaign=prereg"
                  ]
              ]
          }
      }
  }
services/osf.json: |-
  {
      "@class": "org.jasig.cas.services.RegexRegisteredService",
      "id": 203948234207230,
      "name": "",
      "description": "",
      "serviceId": "^https://{{ .Values.osfDomain | replace "." "\\\\." }}/(?!oauth/callback).*",
      "logo": "",
      "evaluationOrder": 2000,
      "attributeReleasePolicy": {
          "@class": "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
          "allowedAttributes": [
              "java.util.ArrayList", [
                  "given-names",
                  "family-name"
              ]
          ]
      },
      "properties": {
          "@class": "java.util.HashMap",
          "title": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "Open Science Framework"
                  ]
              ]
          },
          "titleAbbr": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "OSF"
                  ]
              ]
          },
          "registerUrl": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      ""
                  ]
              ]
          }
      }
  }
services/registries-osf.json: |-
  {
      "@class": "org.jasig.cas.services.RegexRegisteredService",
      "id": 203948234207340,
      "name": "",
      "description": "",
      "serviceId": "^https://{{ .Values.osfDomain | replace "." "\\\\." }}/login/?\\?next=https(%3A|:)(%2F|/)(%2F|/){{ .Values.osfDomain | replace "." "\\\\." }}(%2F|/)registries(%2F|/).*",
      "logo": "https://{{ .Values.casDomain }}/images/registries-osf-logo-black.png",
      "evaluationOrder": 1001,
      "attributeReleasePolicy": {
          "@class": "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
          "allowedAttributes": [
              "java.util.ArrayList", [
                  "given-names",
                  "family-name"
              ]
          ]
      },
      "properties": {
          "@class": "java.util.HashMap",
          "title": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "Open Science Framework"
                  ]
              ]
          },
          "titleAbbr": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "OSF"
                  ]
              ]
          },
          "registerUrl": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "?campaign=osf-registries"
                  ]
              ]
          }
      }
  }
services/preprints-osf.json: |-
  {
      "@class": "org.jasig.cas.services.RegexRegisteredService",
      "id": 203948234207240,
      "name": "",
      "description": "",
      "serviceId": "^https://{{ .Values.osfDomain | replace "." "\\\\." }}/login/?\\?next=https(%3A|:)(%2F|/)(%2F|/){{ .Values.osfDomain | replace "." "\\\\." }}(%2F|/)preprints(%2F|/).*",
      "logo": "https://{{ .Values.casDomain }}/images/preprints-osf-logo-black.png",
      "evaluationOrder": 1001,
      "attributeReleasePolicy": {
          "@class": "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
          "allowedAttributes": [
              "java.util.ArrayList", [
                  "given-names",
                  "family-name"
              ]
          ]
      },
      "properties": {
          "@class": "java.util.HashMap",
          "title": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "Open Science Framework"
                  ]
              ]
          },
          "titleAbbr": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "OSF"
                  ]
              ]
          },
          "registerUrl": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "?campaign=osf-preprints"
                  ]
              ]
          }
      }
  }
{{- $osfDomainRegex := .Values.osfDomain | replace "." "\\\\." -}}
{{- $casDomain := .Values.casDomain -}}
{{- $domainOverride := .Values.preprintProviderDomains.override -}}
{{- $domainPrefix := .Values.preprintProviderDomains.prefix -}}
{{- $domainSuffix := .Values.preprintProviderDomains.suffix -}}
{{- range $key, $val := (include "cas.jetty.preprint-services" . | fromYaml) }}
services/preprints-{{ $key }}.json: |-
  {
      "@class": "org.jasig.cas.services.RegexRegisteredService",
      "id": {{ $val.id }},
      "name": "{{ $val.name }}",
      "description": "",
      "serviceId": "^https://{{ $osfDomainRegex }}/(login|logout)/?\\?next=https(%3A|:)(%2F|/)(%2F|/)
          {{- if hasKey $val "domain" -}}
              (
                {{- if $domainOverride -}}
                    {{- printf "%s%s%s" $domainPrefix $key $domainSuffix | replace "." "\\\\." -}}
                {{- else -}}
                    {{- $val.domain | replace "." "\\\\." -}}
                {{- end -}}
               |{{ $osfDomainRegex }}(%2F|/)preprints(%2F|/){{ $key }}($|%2F|/))
          {{- else -}}
              {{ $osfDomainRegex }}(%2F|/)preprints(%2F|/){{ $key }}
          {{- end -}}
      .*",
      "logo": "https://{{ $casDomain }}/images/preprints-{{ $key }}-logo.png",
      "evaluationOrder": 1000,
      "attributeReleasePolicy": {
          "@class": "org.jasig.cas.services.ReturnAllowedAttributeReleasePolicy",
          "allowedAttributes": [
              "java.util.ArrayList", [
                  "given-names",
                  "family-name"
              ]
          ]
      },
      "properties": {
          "@class": "java.util.HashMap",
          "title": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "Open Science Framework"
                  ]
              ]
          },
          "titleAbbr": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "OSF"
                  ]
              ]
          },
          "registerUrl": {
              "@class": "org.jasig.cas.services.DefaultRegisteredServiceProperty",
              "values": [
                  "java.util.HashSet", [
                      "?campaign={{ $key }}-preprints"
                  ]
              ]
          }
      }
  }
{{- end -}}
{{- end -}}

{{- define "cas.apache.fileconfigs" -}}
{{- range $path, $bytes := .Files.Glob "files/apache/**" }}
{{ $path | trimPrefix "files/apache/" }}: |-
{{ printf "%s" $bytes | indent 2 }}
{{- end -}}
{{- end -}}

{{- define "cas.jetty.fileconfigs" -}}
{{- range $path, $bytes := .Files.Glob "files/jetty/**" }}
{{ $path | trimPrefix "files/jetty/" }}: |-
{{ printf "%s" $bytes | indent 2 }}
{{- end -}}
{{- end -}}

{{- range $key, $value := .Values.apache.configEnvs }}
  apache-{{ $key }}: {{ $value | quote }}
{{- end }}
{{- range $key, $value := merge .Values.apache.configFiles (include "cas.apache.inlineconfigs" . | fromYaml) (include "cas.apache.fileconfigs" . | fromYaml) }}
  apache-{{ $key | replace "/" "-" }}: |-
    {{- $value | nindent 4 }}
{{- end }}

{{- range $key, $value := .Values.jetty.configEnvs }}
  jetty-{{ $key }}: {{ $value | quote }}
{{- end }}
{{- range $key, $value := merge .Values.jetty.configFiles (include "cas.jetty.inlineconfigs" . | fromYaml) (include "cas.jetty.fileconfigs" . | fromYaml) }}
  jetty-{{ $key | replace "/" "-" }}: |-
    {{- $value | nindent 4 }}
{{- end }}
